pipeline {
    agent any
    
    environment {
        PROJECT_NAME = 'candlestick-predictor'
        BUILD_VERSION = "${BUILD_NUMBER}"
    }
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 30, unit: 'MINUTES')
        timestamps()
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'üì• Checking out source code...'
                checkout scm
                script {
                    env.GIT_COMMIT = sh(
                        script: 'git rev-parse HEAD',
                        returnStdout: true
                    ).trim()
                    env.GIT_BRANCH = sh(
                        script: 'git rev-parse --abbrev-ref HEAD',
                        returnStdout: true
                    ).trim()
                }
                echo "‚úÖ Checked out branch: ${env.GIT_BRANCH}"
                echo "‚úÖ Commit: ${env.GIT_COMMIT.take(7)}"
            }
        }
        
        stage('Environment Validation') {
            steps {
                echo 'üîç Validating environment...'
                sh '''
                    echo "Docker version:"
                    docker --version || echo "‚ùå Docker not found"
                    
                    echo "Ansible version:"
                    ansible --version || echo "‚ùå Ansible not found"
                    
                    echo "Git version:"
                    git --version || echo "‚ùå Git not found"
                '''
            }
        }
        
        stage('Deploy to AppServer') {
            steps {
                echo 'üöÄ Deploying to AppServer VM...'
                sh '''
                    cd /var/lib/jenkins/workspace/candlestick-predictor-pipeline
                    
                    # Run Ansible playbook
                    ansible-playbook -i devops/ansible/inventories/vagrant \
                        devops/ansible/playbooks/deploy-app.yml \
                        -e "build_version=${BUILD_VERSION}" \
                        -v
                '''
                echo '‚úÖ Deployment completed!'
            }
        }
        
        stage('Verify Deployment') {
            steps {
                echo 'üîç Verifying deployment...'
                sh '''
                    # Check if services are responding
                    echo "Testing Frontend..."
                    curl -f http://192.168.33.11:3000 || echo "‚ö†Ô∏è Frontend not responding"
                    
                    echo "Testing Backend..."
                    curl -f http://192.168.33.11:8000/docs || echo "‚ö†Ô∏è Backend not responding"
                    
                    echo "Testing AI Service..."
                    curl -f http://192.168.33.11:8001/docs || echo "‚ö†Ô∏è AI Service not responding"
                '''
                echo '‚úÖ Verification complete!'
            }
        }
    }
    
    post {
        always {
            echo 'üßπ Cleaning up...'
            cleanWs()
        }
        
        success {
            echo '‚úÖ BUILD SUCCESS!'
            echo "Build #${BUILD_NUMBER} succeeded for ${PROJECT_NAME}"
            echo "Branch: ${GIT_BRANCH}"
            echo "Commit: ${env.GIT_COMMIT?.take(7) ?: 'unknown'}"
        }
        
        failure {
            echo '‚ùå BUILD FAILED!'
            echo "Build #${BUILD_NUMBER} failed for ${PROJECT_NAME}"
        }
    }
}
